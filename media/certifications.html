<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Certifications & Training | Matthew Dubea</title>
  <meta name="description" content="Verified certifications, technical training, and professional memberships for Matthew Dubea." />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#0a66c2" />
  <link rel="icon" href="../assets/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="../style.css" />
  <script defer src="../theme.js"></script>

  <style>
    /* Page-local cosmetics that complement style.css */
    .toolbar-sticky {
      position: sticky;
      top: 0;
      z-index: 30;
      background: var(--bg-light);
      border-bottom: 1px solid var(--border);
      padding-bottom: .5rem;
    }
    body.dark-mode .toolbar-sticky {
      background: var(--bg-dark);
      border-bottom: 1px solid var(--border-dark);
    }
    .hint {
      text-align: center; color: var(--muted); margin: .5rem 0 0;
      font-size: .95rem;
    }
    /* When we disable embeds on mobile, show a neutral doc placeholder */
    .no-embed .cert-card .media {
      background: linear-gradient(180deg, #f7f7f7, #eee);
      display: grid; place-items: center;
    }
    .no-embed .cert-card .media::after {
      content: "Document preview not available on mobile";
      font-size: .85rem; color: var(--muted);
    }
    /* Make the lightbox slightly larger on desktops */
    #lightbox.open #lightbox-frame { width: 90vw; height: 86vh; }
  </style>
</head>

<body class="fade-in">
  <header class="site-header">
    <div class="brand">
      <h1>Matthew Dubea</h1>
      <p class="tagline">Mechanical Engineer ¬∑ Design ¬∑ Fabrication ¬∑ Automation</p>
    </div>
    <nav class="site-nav" aria-label="Primary">
      <ul class="nav-links">
        <li><a href="../index.html">Home</a></li>
        <li><a href="../about.html">About</a></li>
        <li><a href="../resume.html">Resume</a></li>
        <li><a href="../reports.html">Reports</a></li>
        <li><a class="active" href="certifications.html" aria-current="page">Certifications</a></li>
        <li class="theme-toggle"><button id="darkModeToggle" title="Toggle color theme" aria-label="Toggle color theme">üñ•Ô∏è</button></li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- Hero -->
    <section class="hero" style="padding-bottom:1rem">
      <h2>Certifications & Training</h2>
      <p>All certifications are from verified technical training, professional associations, and engineering coursework.</p>

      <!-- Quick index (filled after JSON) -->
      <nav id="sectionIndex" class="section-index" aria-label="Section index"></nav>
    </section>

    <!-- Sticky toolbar: search + filters -->
    <div class="toolbar-sticky">
      <div class="searchbar" role="search" aria-label="Search certifications">
        <input id="certSearch" type="search" placeholder="Search title, issuer, category" aria-label="Search by title, issuer, or category" />
        <span id="certCount" aria-live="polite" style="margin-left:.5rem;"></span>
      </div>
      <div id="filters" class="filters" role="tablist" aria-label="Filter categories"></div>
    </div>
    <p class="hint">Tip: use the filter chips or type to search across titles, issuers, and categories.</p>

    <!-- Sections target (rendered from JSON) -->
    <div id="certSections" style="margin-top:.75rem"></div>
  </main>

  <!-- Desktop lightbox -->
  <div id="lightbox" aria-hidden="true">
    <button class="close-lightbox" aria-label="Close">‚úï</button>
    <button id="prevBtn" class="nav-btn" aria-label="Previous">‚Üê</button>
    <iframe id="lightbox-frame" title="Certification document viewer" frameborder="0"></iframe>
    <button id="nextBtn" class="nav-btn" aria-label="Next">‚Üí</button>
  </div>

  <footer>
    <p>¬© 2025 Matthew Dubea &nbsp;|&nbsp; <a href="mailto:mattdubea@outlook.com">mattdubea@outlook.com</a></p>
  </footer>

  <script>
    // ======= Mobile-safe embed policy =======
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const canInlinePDF = !isIOS && window.matchMedia('(min-width: 992px)').matches;
    if (!canInlinePDF) document.body.classList.add('no-embed');

    // ======= DOM helpers =======
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const qs = new URLSearchParams(location.search);

    const sectionsHost = $('#certSections');
    const filtersHost  = $('#filters');
    const indexHost    = $('#sectionIndex');
    const searchInput  = $('#certSearch');
    const resultCount  = $('#certCount');

    // ======= Fetch & render =======
    fetch('certs.json', { cache: 'no-store' })
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(json => render(json))
      .catch(err => {
        console.error('Failed to load certs.json', err);
        sectionsHost.innerHTML = '<p style="text-align:center;color:var(--muted)">Unable to load certifications right now.</p>';
      });

    function render(json) {
      const groups = (json.groups || []).sort((a,b) => (a.order || 0) - (b.order || 0));

      // Section index with counts
      indexHost.innerHTML = groups
        .map(g => `<a href="#sec-${g.id}">${escapeHTML(g.title)} <span style="color:var(--muted)">(${(g.items||[]).length})</span></a>`)
        .join(' ¬∑ ');

      // Filters + deep link
      const initialFilter = (qs.get('filter') || 'all').toLowerCase();
      filtersHost.innerHTML = [
        `<button data-filter="all" class="${initialFilter==='all'?'active':''}" role="tab" aria-selected="${initialFilter==='all'}">All</button>`,
        ...groups.map(g => {
          const isActive = initialFilter === g.id.toLowerCase();
          return `<button data-filter="${g.id}" class="${isActive?'active':''}" role="tab" aria-selected="${isActive}">${escapeHTML(g.title)}</button>`;
        })
      ].join('');

      // Sections
      sectionsHost.innerHTML = groups.map(g => sectionTemplate(g)).join('');
      groups.forEach(g => {
        const grid = document.getElementById(`grid-${g.id}`);
        (g.items || []).forEach(item => grid.insertAdjacentHTML('beforeend', cardTemplate(item)));
      });

      // Lazy <object> PDFs on desktop only
      if (canInlinePDF) setupLazyObjects();

      // Interactions
      setupFilters(initialFilter);
      setupSearch();

      if (canInlinePDF) setupLightbox();
    }

    function sectionTemplate(group) {
      return `
        <details id="sec-${group.id}" data-section open>
          <summary><h3 class="section-title">${escapeHTML(group.title)}</h3></summary>
          <div class="certifications-grid" id="grid-${group.id}"></div>
        </details>`;
    }

    function cardTemplate(item) {
      const isImage = (item.type || '').toLowerCase() === 'image';
      const file    = item.file;
      const issuer  = (item.issuer || '').trim();
      const badges  = (item.badges || []).map(b => `<span class="badge">${escapeHTML(b)}</span>`).join('');
      const openBtn = `<a class="btn outline" href="${file}" target="_blank" rel="noopener">Open</a>`;
      const dlBtn   = `<a class="btn outline" href="${file}" download>Download</a>`;

      let media = '';
      if (canInlinePDF) {
        if (isImage) {
          media = `<img class="media" src="${file}" alt="${escapeHTML(item.title)}" loading="lazy" />`;
        } else {
          media = `
            <object class="media" type="application/pdf" data="" data-src="${file}">
              <div style="padding:1rem;text-align:center">
                <p style="margin:.25rem 0 .5rem;color:var(--muted)">Preview failed to load.</p>
                ${openBtn}
              </div>
            </object>`;
        }
      } else {
        media = `<div class="media" aria-hidden="true"></div>`;
      }

      return `
        <article class="cert-card" data-file="${file}" data-category="${(item.category || []).join(' ')}" role="group" aria-label="${escapeHTML(item.title)}">
          ${media}
          <div class="cert-body">
            <div class="cert-title">${escapeHTML(item.title)}</div>
            <div class="cert-badges">
              ${issuer ? `<span class="badge">Issuer: ${escapeHTML(issuer)}</span>` : ''}${badges}
            </div>
            <div class="cta-row" style="gap:.5rem;flex-wrap:wrap">${openBtn}${dlBtn}</div>
          </div>
        </article>`;
    }

    function setupLazyObjects() {
      const lazyObjs = $$('object.media[data-src]');
      if (!lazyObjs.length) return;

      const io = new IntersectionObserver(entries => {
        entries.forEach(e => {
          if (e.isIntersecting) {
            const el  = e.target;
            const src = el.getAttribute('data-src');
            if (src && !el.getAttribute('data')) {
              el.setAttribute('data', src);
              // If the PDF plug-in errors, show the inline fallback
              el.addEventListener('error', () => {
                el.outerHTML = `
                  <div style="padding:1rem;text-align:center">
                    <p style="margin:.25rem 0 .5rem;color:var(--muted)">Preview unavailable.</p>
                    <a class="btn outline" href="${src}" target="_blank" rel="noopener">Open</a>
                  </div>`;
              });
              io.unobserve(el);
            }
          }
        });
      }, { rootMargin: '200px' });

      lazyObjs.forEach(el => io.observe(el));
    }

    function setupFilters(initial) {
      let active = (initial || 'all').toLowerCase();
      const buttons  = $$('#filters button');
      const sections = $$('[data-section]');

      function apply(needle) {
        const cards = $$('.cert-card');
        let visible = 0;

        cards.forEach(card => {
          const cats   = (card.getAttribute('data-category') || '').toLowerCase().split(/\s+/);
          const title  = card.querySelector('.cert-title')?.textContent.toLowerCase() || '';
          const issuer = card.querySelector('.cert-badges')?.textContent.toLowerCase() || '';
          const fOK    = active === 'all' || cats.includes(active);
          const sOK    = !needle || title.includes(needle) || issuer.includes(needle) || cats.join(' ').includes(needle);
          const show   = fOK && sOK;
          card.hidden  = !show;
          if (show) visible++;
        });

        sections.forEach(sec => {
          const hasVisible = sec.querySelector('.cert-card:not([hidden])');
          sec.hidden = !hasVisible;
          if (hasVisible) sec.setAttribute('open','');
        });

        if (resultCount) resultCount.textContent = visible ? `${visible} shown` : 'No results';
      }

      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          active = btn.dataset.filter.toLowerCase();
          // update URL (no navigation)
          const url = new URL(location.href);
          if (active === 'all') url.searchParams.delete('filter');
          else url.searchParams.set('filter', active);
          history.replaceState({}, '', url);

          buttons.forEach(b => b.classList.toggle('active', b === btn));
          buttons.forEach(b => b.setAttribute('aria-selected', b === btn ? 'true' : 'false'));
          apply((searchInput?.value || '').toLowerCase());
        });
      });

      // initial application
      apply((searchInput?.value || '').toLowerCase());
    }

    function setupSearch() {
      searchInput?.addEventListener('input', () => {
        // re-apply current filter after text changes
        const activeBtn = $('#filters button.active') || $('#filters button[data-filter="all"]');
        activeBtn?.click();
      });
    }

    // Desktop-only lightbox
    function setupLightbox() {
      const lightbox = $('#lightbox');
      const frame    = $('#lightbox-frame');
      const prevBtn  = $('#prevBtn');
      const nextBtn  = $('#nextBtn');
      const closeBtn = $('.close-lightbox');
      let currentIndex = -1;
      let lastFocused  = null;

      function visibleCards() {
        return $$('.cert-card').filter(c => !c.hidden && c.offsetParent !== null);
      }
      function indexFromFile(f) {
        const list = visibleCards();
        return list.findIndex(c => (c.getAttribute('data-file') || '') === f);
      }
      function openLightbox(src) {
        lastFocused = document.activeElement;
        currentIndex = indexFromFile(src);
        frame.src = src;
        lightbox.classList.add('open');
        lightbox.setAttribute('aria-hidden', 'false');
        closeBtn.focus();
        document.addEventListener('keydown', onKey);
      }
      function closeLightbox() {
        lightbox.classList.remove('open');
        lightbox.setAttribute('aria-hidden', 'true');
        frame.src = 'about:blank';
        document.removeEventListener('keydown', onKey);
        if (lastFocused) lastFocused.focus();
      }
      function showAt(i) {
        const list = visibleCards();
        if (!list.length) return;
        currentIndex = (i + list.length) % list.length;
        const src = list[currentIndex].getAttribute('data-file');
        frame.src = src;
      }
      function onKey(e) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') showAt(currentIndex - 1);
        if (e.key === 'ArrowRight') showAt(currentIndex + 1);
      }

      prevBtn.addEventListener('click', e => { e.stopPropagation(); showAt(currentIndex - 1); });
      nextBtn.addEventListener('click', e => { e.stopPropagation(); showAt(currentIndex + 1); });
      closeBtn.addEventListener('click', e => { e.stopPropagation(); closeLightbox(); });
      lightbox.addEventListener('click', e => { if (e.target === lightbox) closeLightbox(); });

      // Only cards (not the explicit Open/Download links) open the lightbox
      document.addEventListener('click', e => {
        const card = e.target.closest('.cert-card');
        if (!card) return;
        if (e.target.closest('a')) return; // let links work
        const src = card.getAttribute('data-file');
        if (src) openLightbox(src);
      });
    }

    function escapeHTML(s) {
      return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }
  </script>
</body>
</html>
